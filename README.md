# Sparky - Claude Code Monitor & Feishu Connector

**Sparky** æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Claude Code ä¼´ä¾£åº”ç”¨ï¼Œæ—¨åœ¨é€šè¿‡é£ä¹¦ï¼ˆFeishuï¼‰å®ç°å¯¹ Claude Code çš„è¿œç¨‹ç›‘æ§ã€æƒé™ç®¡ç†å’Œäº¤äº’æ§åˆ¶ã€‚å®ƒç»“åˆäº† Rust çš„é«˜æ€§èƒ½åç«¯ä¸ Tauri çš„è·¨å¹³å°èƒ½åŠ›ï¼Œä¸ºæ‚¨æä¾›æ— ç¼çš„ AI è¾…åŠ©ç¼–ç ä½“éªŒã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸš€ å®æ—¶ç›‘æ§ä¸äº¤äº’**ï¼š
    - è‡ªåŠ¨æ•è· Claude Code çš„è¾“å‡ºæµã€‚
    - æ™ºèƒ½è¯†åˆ« `Permission Request`ï¼ˆæƒé™è¯·æ±‚ï¼‰å’Œ `Stop`ï¼ˆä»»åŠ¡ç»“æŸï¼‰äº‹ä»¶ã€‚
    - å°†å…³é”®ä¿¡æ¯å®æ—¶æ¨é€åˆ°é£ä¹¦ç¾¤èŠã€‚

- **ğŸ” è¿œç¨‹æƒé™ç®¡ç†**ï¼š
    - å½“ Claude Code è¯·æ±‚å‘½ä»¤æ‰§è¡Œæƒé™ï¼ˆå¦‚ `Do you want to proceed?`ï¼‰æ—¶ï¼Œè‡ªåŠ¨å‘é€é£ä¹¦å¡ç‰‡ã€‚
    - æ”¯æŒåœ¨é£ä¹¦ä¸­ç›´æ¥ç‚¹å‡»æŒ‰é’®ï¼ˆYes/Noï¼‰è¿›è¡Œæˆæƒï¼Œæ— éœ€åˆ‡å›ç»ˆç«¯ã€‚
    - **[New]** æ”¯æŒé€šè¿‡è¾“å…¥é…å¯¹ç ï¼ˆå¦‚ `1234-1`ï¼‰è¿›è¡Œè¿œç¨‹å‘½ä»¤é€‰æ‹©ã€‚

- **ğŸ’¬ é£ä¹¦æ·±åº¦é›†æˆ**ï¼š
    - **WebSocket é•¿è¿æ¥**ï¼šæ— éœ€å…¬ç½‘ IPï¼Œæ— éœ€å†…ç½‘ç©¿é€ï¼Œé…ç½® App ID/Secret å³å¯ä½¿ç”¨ã€‚
    - **å¤šç¯å¢ƒæ”¯æŒ**ï¼šæ”¯æŒé…ç½®â€œåº”ç”¨åç§°â€ï¼ˆå¦‚ `Production`, `Dev`ï¼‰ä»¥åŒºåˆ†ä¸åŒç¯å¢ƒçš„é€šçŸ¥ã€‚
    - **æ¶ˆæ¯é˜²æŠ–**ï¼šæ™ºèƒ½æŠ‘åˆ¶é‡å¤çš„å‘½ä»¤æ‰§è¡Œé€šçŸ¥ï¼Œä¿æŒç¾¤èŠæ•´æ´ã€‚

- **ğŸ–¥ï¸ ç°ä»£åŒ– UI ç•Œé¢**ï¼š
    - **Tauri + React + Ant Design** æ„å»ºçš„é«˜æ€§èƒ½æ¡Œé¢åº”ç”¨ã€‚
    - **æ·±è‰²/æµ…è‰²æ¨¡å¼**ï¼šè‡ªåŠ¨è·Ÿéšç³»ç»Ÿï¼Œç²¾å¿ƒè°ƒä¼˜çš„å¯¹æ¯”åº¦ä¸é˜´å½±æ•ˆæœã€‚
    - **é¡¹ç›®ç®¡ç†**ï¼šå›¾å½¢åŒ–ç®¡ç†å¤šä¸ª Claude Code é¡¹ç›®ï¼Œä¸€é”®å®‰è£…/å¸è½½ Hooksã€‚
    - **åŸç”Ÿä½“éªŒ**ï¼šæ”¯æŒä¸€é”®åœ¨ Finder/èµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€é¡¹ç›®æ–‡ä»¶å¤¹ã€‚

- **ğŸ’¾ å¥å£®çš„æ•°æ®æŒä¹…åŒ–**ï¼š
    - å†…ç½® **SQLite** æ•°æ®åº“ï¼Œå®Œæ•´è®°å½•æ‰€æœ‰ Hook äº‹ä»¶ã€æƒé™è¯·æ±‚å†å²å’Œç»ˆç«¯äº¤äº’æ—¥å¿—ã€‚
    - è‡ªåŠ¨ä¿å­˜åº”ç”¨é…ç½®ï¼Œé‡å¯æ— å¿§ã€‚

## ğŸ› ï¸ æ¶æ„æ¦‚è§ˆ

Sparky é‡‡ç”¨è¯»å†™åˆ†ç¦»çš„ç°ä»£åŒ–æ¶æ„ï¼š

```mermaid
graph TD
    subgraph "Claude Code Environment"
        Claude[Claude Code CLI]
        Hook[Sparky Hook (Rust CLI)]
    end

    subgraph "Sparky Desktop App"
        Tauri[Tauri Core (Rust)]
        DB[(SQLite Database)]
        WS[WebSocket Client]
        UI[React Frontend]
    end

    subgraph "Feishu Cloud"
        Feishu[Feishu Open Platform]
    end

    Claude -->|Stdout/Stdin| Hook
    Hook -->|Write Events| DB
    Tauri -->|Read/Poll| DB
    Tauri <-->|WebSocket| Feishu
    UI <-->|Tauri Invoke| Tauri
```

- **Hooks**: è½»é‡çº§ Rust CLIï¼Œæ³¨å…¥åˆ° Claude Code è¿›ç¨‹ä¸­ï¼Œè´Ÿè´£æ•è· I/O å¹¶å†™å…¥æ•°æ®åº“ã€‚
- **Desktop App**: è´Ÿè´£åå°é€»è¾‘ï¼ˆWebSocket è¿æ¥ã€æ•°æ®åº“è½®è¯¢ã€PTY æ§åˆ¶ï¼‰å’Œå‰å°äº¤äº’ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®é£ä¹¦æœºå™¨äºº
1. å‰å¾€ [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/) åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨ã€‚
2. å¼€å¯ **æœºå™¨äºº** èƒ½åŠ›ã€‚
3. è·å– `App ID` å’Œ `App Secret`ã€‚
4. (å¯é€‰) è·å– `Encrypt Key` å’Œ `Verification Token`ã€‚

### 2. å®‰è£…ä¸è¿è¡Œ
**å¼€å‘æ¨¡å¼å¯åŠ¨**:
```bash
# å¯åŠ¨å‰ç«¯ä¸åç«¯å¼€å‘æœåŠ¡
./start-dev.sh
```

**æ„å»ºç”Ÿäº§ç‰ˆæœ¬**:
```bash
./build.sh
```

### 3. åº”ç”¨é…ç½®
1. æ‰“å¼€ Sparky æ¡Œé¢åº”ç”¨ã€‚
2. è¿›å…¥ **è®¾ç½®ä¸­å¿ƒ** -> **é£ä¹¦åº”ç”¨é…ç½®**ã€‚
3. å¡«å†™ `App ID`ã€`App Secret` å’Œ `åº”ç”¨åç§°`ã€‚
4. ç‚¹å‡» **ä¿å­˜é…ç½®**ï¼Œåº”ç”¨å°†è‡ªåŠ¨å»ºç«‹ WebSocket è¿æ¥ã€‚

### 4. é¡¹ç›®æ¥å…¥
1. åœ¨ **é¡¹ç›®ç®¡ç†** é¡µç­¾ä¸­ï¼Œç‚¹å‡» **æ·»åŠ é¡¹ç›®**ã€‚
2. é€‰æ‹©æ‚¨çš„ Claude Code é¡¹ç›®æ ¹ç›®å½•ã€‚
3. ç‚¹å‡» **å®‰è£… Hooks**ï¼ŒSparky ä¼šè‡ªåŠ¨é…ç½® `.claude/config.json`ã€‚
4. æ­¤æ—¶ï¼Œè¯¥é¡¹ç›®ä¸‹çš„ Claude Code è¿è¡Œè®°å½•å°†è¢«å®æ—¶ç›‘æ§ã€‚

## ğŸ“¦ ç›®å½•ç»“æ„

```
claude-monitor/
â”œâ”€â”€ src/                    # Hook CLI æºä»£ç  (Rust)
â”‚   â”œâ”€â”€ main.rs             # CLI å…¥å£
â”‚   â”œâ”€â”€ hooks.rs            # æ ¸å¿ƒ Hook é€»è¾‘
â”‚   â”œâ”€â”€ feishu.rs           # é£ä¹¦æ¶ˆæ¯æ„é€ 
â”‚   â””â”€â”€ websocket.rs        # WebSocket å®¢æˆ·ç«¯
â”œâ”€â”€ src-tauri/              # Tauri æ¡Œé¢åç«¯ (Rust)
â”‚   â”œâ”€â”€ src/lib.rs          # æ•°æ®åº“ã€é…ç½®ä¸ PTY ç®¡ç†
â”‚   â”œâ”€â”€ migrations/         # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â””â”€â”€ tauri.conf.json     # Tauri é…ç½®
â”œâ”€â”€ ui/                     #å‰å°ç•Œé¢ (React + TS)
â”‚   â”œâ”€â”€ src/App.tsx         # ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ src/App.css         # æ ·å¼ (åŒ…å«æ·±æµ…è‰²æ¨¡å¼é€‚é…)
â”‚   â””â”€â”€ src/components/     # UI ç»„ä»¶
â”œâ”€â”€ Cargo.toml              # Rust å·¥ä½œåŒºä¾èµ–
â””â”€â”€ build.sh                # è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬
```

## ğŸ“œ License

MIT License

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨æ¡Œé¢åº”ç”¨ï¼ˆæ¨èï¼‰

1. **å¯åŠ¨å¼€å‘æ¨¡å¼**
   ```bash
   ./start-dev.sh
   ```
   
   æˆ–æ‰‹åŠ¨å¯åŠ¨ï¼š
   ```bash
   cd ui && npm install && cd ..
   cargo tauri dev
   ```

2. **æ„å»ºç”Ÿäº§ç‰ˆæœ¬**
   ```bash
   ./build.sh
   ```
   
   æ„å»ºå®Œæˆåï¼Œåº”ç”¨ä½äº `src-tauri/target/release/bundle/` ç›®å½•

3. **ä½¿ç”¨åº”ç”¨é…ç½®**
   - åœ¨åº”ç”¨ç•Œé¢ä¸­å¡«å†™é£ä¹¦ Webhook URL
   - ç‚¹å‡»"æµ‹è¯• Webhook è¿æ¥"éªŒè¯é…ç½®
   - ç‚¹å‡»"ä¿å­˜é…ç½®"
   - é…ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°

### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œæ¨¡å¼

#### 1. é…ç½®é£ä¹¦æœºå™¨äºº

1. åœ¨é£ä¹¦ä¸­åˆ›å»ºè‡ªå®šä¹‰æœºå™¨äºº
2. è·å– Webhook URL
3. é…ç½®æœºå™¨äººæ¶ˆæ¯å¡ç‰‡å›è°ƒåœ°å€ (http://your-server:3000/feishu/callback)

#### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™é…ç½®:

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶:

```env
FEISHU_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token
SERVER_HOST=0.0.0.0
SERVER_PORT=3000
```

#### 3. æ„å»ºé¡¹ç›®

```bash
cargo build --release
```

#### 4. é…ç½® Claude Code Hooks

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.claude/settings.local.json`:

```json
{
  "hooks": {
    "Notification": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/claude-monitor hook"
          }
        ]
      }
    ]
  }
}
```

æˆ–åœ¨ç”¨æˆ·å…¨å±€é…ç½® `~/.claude/settings.json` ä¸­æ·»åŠ ä¸Šè¿°é…ç½®ã€‚

#### 5. å¯åŠ¨æœåŠ¡å™¨æ¨¡å¼ (å¯é€‰)

å¦‚æœéœ€è¦ç‹¬ç«‹è¿è¡ŒæœåŠ¡å™¨:

```bash
./target/release/claude-monitor server
```

## ä½¿ç”¨æ–¹å¼

### Hook æ¨¡å¼

å½“ Claude Code éœ€è¦ç”¨æˆ·ç¡®è®¤æ—¶,ä¼šè‡ªåŠ¨è§¦å‘ Notification hook,ç›‘è§†å™¨ä¼š:

1. è¯»å– Claude Code å‘é€çš„é€šçŸ¥å†…å®¹
2. å‘é€äº¤äº’å¼å¡ç‰‡åˆ°é£ä¹¦
3. ç­‰å¾…ç”¨æˆ·åœ¨é£ä¹¦ä¸­ç‚¹å‡»æŒ‰é’®
4. å°†ç”¨æˆ·çš„é€‰æ‹©è¿”å›ç»™ Claude Code

### æœåŠ¡å™¨æ¨¡å¼

ç‹¬ç«‹è¿è¡Œ HTTP æœåŠ¡å™¨,æ¥æ”¶é£ä¹¦çš„å›è°ƒè¯·æ±‚:

```bash
./target/release/claude-monitor server
```

## æ¶æ„è¯´æ˜

```
claude-monitor/
â”œâ”€â”€ src/                    # CLI æ¨¡å¼æºä»£ç 
â”‚   â”œâ”€â”€ main.rs            # ä¸»ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ config.rs          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ hooks.rs           # Claude Code hooks å¤„ç†
â”‚   â”œâ”€â”€ feishu.rs          # é£ä¹¦æœºå™¨äººé›†æˆ
â”‚   â””â”€â”€ server.rs          # HTTP æœåŠ¡å™¨
â”œâ”€â”€ src-tauri/              # Tauri æ¡Œé¢åº”ç”¨
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ lib.rs         # Tauri åç«¯é€»è¾‘
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ tauri.conf.json    # Tauri é…ç½®
â”œâ”€â”€ ui/                     # å‰ç«¯ç•Œé¢
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx        # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”‚   â””â”€â”€ App.css        # æ ·å¼
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.ts
â”œâ”€â”€ Cargo.toml             # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ .env.example           # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ start-dev.sh           # å¼€å‘å¯åŠ¨è„šæœ¬
â””â”€â”€ build.sh               # æ„å»ºè„šæœ¬
```

## å·¥ä½œæµç¨‹

1. Claude Code è§¦å‘ Notification äº‹ä»¶
2. Hook ç›‘å¬å™¨è¯»å– stdin ä¸­çš„ JSON æ•°æ®
3. è§£æé€šçŸ¥å†…å®¹,åˆ¤æ–­æ˜¯å¦éœ€è¦ç”¨æˆ·äº¤äº’
4. å‘é€äº¤äº’å¼å¡ç‰‡åˆ°é£ä¹¦
5. å¯åŠ¨ä¸´æ—¶ HTTP æœåŠ¡å™¨ç­‰å¾…å›è°ƒ
6. ç”¨æˆ·åœ¨é£ä¹¦ä¸­ç‚¹å‡»æŒ‰é’®
7. é£ä¹¦å‘é€å›è°ƒåˆ° HTTP æœåŠ¡å™¨
8. å°†ç”¨æˆ·é€‰æ‹©è¿”å›ç»™ Claude Code

## æ³¨æ„äº‹é¡¹

- é£ä¹¦æœºå™¨äººéœ€è¦æœ‰æ¶ˆæ¯å¡ç‰‡å›è°ƒæƒé™
- HTTP æœåŠ¡å™¨éœ€è¦å…¬ç½‘å¯è®¿é—® (å¯ä½¿ç”¨ ngrok ç­‰å·¥å…·)
- é£ä¹¦å›è°ƒåœ°å€éœ€è¦é…ç½®ä¸º: `http://your-server:3000/feishu/callback`

## å¼€å‘

### å¼€å‘æ¨¡å¼

```bash
# Tauri æ¡Œé¢åº”ç”¨å¼€å‘æ¨¡å¼
./start-dev.sh

# CLI æ¨¡å¼å¼€å‘
cargo run -- hook
cargo run -- server
```

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
# æ„å»º Tauri åº”ç”¨
./build.sh

# æ„å»º CLI ç‰ˆæœ¬
cargo build --release
```

### æŠ€æœ¯æ ˆ

- **åç«¯**: Rust + Tauri 2.0
- **å‰ç«¯**: React + TypeScript + Vite
- **UI æ¡†æ¶**: Ant Design
- **åŠŸèƒ½**:
  - Claude Code Hooks é›†æˆ
  - é£ä¹¦æœºå™¨äºº API
  - HTTP æœåŠ¡å™¨ï¼ˆAxumï¼‰
  - æœ¬åœ°é…ç½®ç®¡ç†

## License

MIT
