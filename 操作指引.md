# Claude Monitor 操作指引

## 📋 目录

- [项目简介](#项目简介)
- [前置准备](#前置准备)
- [飞书开放平台配置](#飞书开放平台配置)
- [应用配置](#应用配置)
- [使用方法](#使用方法)
- [常见问题](#常见问题)

---

## 项目简介

Claude Monitor 是一个基于 Rust + Tauri 开发的 Claude Code 监视器，通过飞书开放平台的长连接模式实现远程交互。

### ✨ 核心特性

- 🖥️ 图形化配置界面（Tauri 桌面应用）
- 🔌 长连接模式（无需公网 IP）
- 📱 飞书消息推送与交互
- 💾 本地配置保存
- 🎨 黑白灰简约风格

### 🔄 工作流程

```
Claude Code 触发确认提示
    ↓
Hook 监听器捕获通知
    ↓
发送交互式卡片到飞书
    ↓
用户在飞书中点击按钮
    ↓
通过长连接接收用户选择
    ↓
返回结果给 Claude Code
```

---

## 前置准备

### 1. 系统要求

- **操作系统**：macOS 10.15+、Windows 10+、Linux
- **软件环境**：
  - Node.js 16+
  - Rust 1.70+
  - Python 3.x（可选，用于脚本）

### 2. 检查环境

```bash
# 检查 Node.js
node --version

# 检查 Rust
rustc --version

# 检查 Cargo
cargo --version
```

---

## 飞书开放平台配置

### 步骤一：创建应用

1. **访问飞书开发者后台**
   - 打开 https://open.feishu.cn/app
   - 使用飞书账号登录

2. **创建企业自建应用**
   - 点击"创建企业自建应用"
   - 填写应用名称：`Claude Monitor`
   - 填写应用描述：`Claude Code 远程监控助手`
   - 上传应用图标（可选）
   - 点击"创建"

### 步骤二：配置机器人能力

1. **开启机器人**
   - 在应用详情页，找到"应用能力"
   - 点击"添加能力"
   - 选择"机器人"
   - 点击"添加"

2. **配置机器人信息**
   - 机器人名称：`Claude Monitor`
   - 机器人描述：`Claude Code 远程监控助手`
   - 上传机器人头像（可选）

### 步骤三：配置权限

在"权限管理"页面，申请以下权限：

#### 必需权限

| 权限名称 | 权限代码 | 用途 |
|---------|---------|------|
| 获取与发送消息 | `im:message` | 发送监控消息 |
| 接收群聊@消息 | `im:message.group_at_msg` | 接收群聊指令 |
| 接收单聊消息 | `im:message.p2p_msg` | 接收私聊指令 |
| 以应用身份发消息 | `im:message:send_as_bot` | 以机器人身份发送消息 |

#### 申请权限步骤

1. 在权限管理页面，搜索权限名称或代码
2. 点击"申请权限"
3. 填写申请理由
4. 提交申请

### 步骤四：配置事件订阅（长连接模式）

1. **进入事件配置**
   - 在应用详情页，找到"事件与回调"
   - 点击"添加事件"

2. **添加事件订阅**
   - 搜索并添加以下事件：
     - `接收消息`（im.message.receive_v1）：接收消息事件
     - `卡片按钮回调`（card.action.trigger）：接收卡片按钮点击事件

3. **配置长连接**
   - 在"订阅方式"中，选择"使用长连接接收事件"
   - **重要**：不要选择 HTTP 回调，选择长连接模式
   - 保存配置

4. **验证连接状态**
   - 启动本地的长连接服务后
   - 飞书开发者后台会显示"已连接"状态

### 步骤五：获取应用凭证

1. **查看凭证**
   - 在应用详情页，找到"凭证与基础信息"
   - 记录以下信息：
     - **App ID**：`cli_xxxxxxxxxxxxxxxx`
     - **App Secret**：`xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

2. **可选：获取加密凭证**
   - Encrypt Key：在"事件与回调"中查看
   - Verification Token：在"事件与回调"中查看

### 步骤六：发布应用

1. **创建版本**
   - 在应用详情页，点击"创建版本"
   - 填写版本号：`1.0.0`
   - 填写版本说明：`初始版本`
   - 点击"保存"

2. **提交审核**
   - 点击"提交审核"
   - 等待审核通过（通常 1-3 个工作日）

3. **启用应用**
   - 审核通过后，在飞书管理后台启用应用
   - 在群聊或单聊中添加机器人

---

## 应用配置

### 方式一：使用桌面应用（推荐）

#### 1. 启动应用

```bash
# 进入项目目录
cd /Users/yingzhang/Documents/dev/claude-monitor

# 启动开发模式
./start-dev.sh
```

#### 2. 填写配置

在应用界面中填写：

- **App ID**：从飞书开发者后台获取
- **App Secret**：从飞书开发者后台获取
- **Encrypt Key**（可选）：用于消息加密
- **Verification Token**（可选）：用于验证消息来源

#### 3. 测试连接

点击"测试连接"按钮，验证配置是否正确。

成功提示：`飞书应用配置验证成功！`

#### 4. 保存配置

点击"保存配置"按钮，配置会自动保存到本地。

**配置文件位置**：
- macOS: `~/Library/Application Support/com.claude.monitor/config.json`
- Windows: `%APPDATA%\com.claude.monitor\config.json`
- Linux: `~/.config/com.claude.monitor/config.json`

### 方式二：使用环境变量

#### 1. 创建配置文件

```bash
# 复制配置模板
cp .env.example .env

# 编辑配置文件
nano .env
```

#### 2. 填写配置

```env
# 飞书开放平台应用配置
FEISHU_APP_ID=cli_xxxxxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
FEISHU_CHAT_ID=oc_xxxxxxxxxxxxxxxxxxxxxxxx
```

#### 3. 获取 Chat ID

**方法一：通过 API 获取**

```bash
# 获取 tenant_access_token
curl -X POST "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal" \
  -H "Content-Type: application/json" \
  -d '{
    "app_id": "cli_xxxxxxxxxxxxxxxx",
    "app_secret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  }'

# 获取群聊列表
curl -X GET "https://open.feishu.cn/open-apis/im/v1/chats" \
  -H "Authorization: Bearer {tenant_access_token}"
```

**方法二：在飞书中查看**

1. 在飞书群聊中，点击群设置
2. 查看群信息
3. 找到群 ID（Chat ID）

---

## 使用方法

### 1. 构建 CLI 工具

```bash
# 开发模式
cargo build

# 生产模式
cargo build --release
```

### 2. 测试消息发送

```bash
# 发送测试消息到飞书
./target/debug/claude-monitor test
# 或
./target/release/claude-monitor test
```

成功后会在飞书中看到测试消息。

### 3. 启动长连接服务（重要！）

**必须启动长连接服务才能接收飞书事件（如用户点击卡片按钮）**

#### 方式一：Rust 版本（推荐）

```bash
# 启动长连接服务
./target/release/claude-monitor connect

# 带详细日志启动
RUST_LOG=info ./target/release/claude-monitor connect

# 后台运行
nohup ./target/release/claude-monitor connect > feishu-ws.log 2>&1 &
```

#### 方式二：Python 版本（备选）

```bash
# 安装依赖
pip3 install lark-oapi pycryptodome python-socks

# 启动服务
python3 feishu_ws_client.py
```

#### 验证连接

启动成功后会看到类似日志：
```
[INFO] Got WebSocket URL: wss://msg-frontier.feishu.cn/ws/v2?...
[INFO] WebSocket connected successfully
```

飞书开发者后台的"事件订阅"配置中，长连接状态应该显示为"已连接"。

### 4. 配置 Claude Code Hooks

#### 项目级配置

在项目根目录创建 `.claude/settings.local.json`：

```json
{
  "hooks": {
    "Notification": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "/Users/yingzhang/Documents/dev/claude-monitor/target/release/claude-monitor hook"
          }
        ]
      }
    ]
  }
}
```

#### 全局配置

在 `~/.claude/settings.json` 中添加相同配置。

**注意**：请将路径替换为实际的绝对路径。

### 4. 工作流程

1. **启动 Claude Code**
   ```bash
   claude
   ```

2. **触发确认提示**
   - 当 Claude Code 需要用户确认时，会触发 Notification 事件

3. **接收飞书消息**
   - 在飞书中收到交互式卡片消息
   - 包含确认内容和 Yes/No 按钮

4. **回复选择**
   - 点击"✅ Yes (1)"或"❌ No (2)"
   - 选择会通过长连接返回

### 5. 构建桌面应用

```bash
# 构建 Tauri 应用
./build.sh

# 或手动构建
cd ui && npm run build && cd ..
cargo tauri build
```

**输出位置**：
- macOS: `src-tauri/target/release/bundle/macos/Claude Monitor.app`
- Windows: `src-tauri/target/release/bundle/msi/`
- Linux: `src-tauri/target/release/bundle/deb/`

---

## 常见问题

### Q1: 无法发送消息到飞书

**解决方案**：

1. 检查 App ID 和 App Secret 是否正确
2. 确认应用已发布并启用
3. 检查权限配置是否完整
4. 验证 Chat ID 是否正确
5. 查看应用日志排查错误

### Q2: 收不到用户回复 / 飞书提示"应用未建立长连接"

**解决方案**：

1. **启动长连接服务**
   ```bash
   ./target/release/claude-monitor connect
   ```
2. 确认已配置事件订阅（长连接模式）
3. 在飞书开发者后台添加 `card.action.trigger` 事件
4. 查看控制台日志确认 WebSocket 连接成功
5. 检查权限配置是否完整

### Q3: Hook 不触发

**解决方案**：

1. 检查 `.claude/settings.json` 配置是否正确
2. 确认命令路径是绝对路径
3. 确保二进制文件有执行权限：`chmod +x claude-monitor`
4. 运行 `claude --debug` 查看详细日志

### Q4: 配置保存失败

**解决方案**：

1. 检查应用是否有写入权限
2. 查看应用日志
3. 确认磁盘空间充足
4. 手动创建配置目录

### Q5: 长连接模式和 HTTP 回调模式的区别

| 特性 | 长连接模式 | HTTP 回调 |
|------|----------|----------|
| 公网 IP | 不需要 | 需要 |
| 端口转发 | 不需要 | 需要 |
| ngrok 等工具 | 不需要 | 需要 |
| 配置复杂度 | 简单 | 复杂 |
| 稳定性 | 高 | 中 |
| 延迟 | 低 | 中 |

**推荐使用长连接模式**。

---

## 📚 相关资源

- [飞书开放平台文档](https://open.feishu.cn/document/)
- [飞书机器人开发指南](https://open.feishu.cn/document/home/introduction-to-feishu-platform/bot-development-Overview/)
- [消息卡片搭建工具](https://open.feishu.cn/cardkit)
- [Claude Code Hooks 文档](https://www.runoob.com/claude-code/claude-code-hooks.html)
- [Tauri 官方文档](https://tauri.app/)

---

## 📝 更新日志

### v0.1.0 (2026-02-13)

- ✨ 初始版本发布
- 🖥️ Tauri 桌面应用
- 🔌 飞书长连接模式支持
- 💾 本地配置保存
- 🎨 黑白灰简约风格界面

---

## 💬 获取帮助

如遇到问题，可以：

1. 查看本文档的常见问题部分
2. 查看 DEPLOYMENT.md 获取详细部署信息
3. 查看 TAURI_GUIDE.md 了解 Tauri 应用使用方法
4. 查看应用日志排查问题

---

**祝你使用愉快！** 🎉
